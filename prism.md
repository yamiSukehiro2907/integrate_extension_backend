# üß© VS Code Extension Backend ‚Äì Prism Integration Guide

This guide explains how to integrate your VS Code extension with the API Spec microservice and run a mock API server using [Prism](https://github.com/stoplightio/prism).  
You'll enable instant contract-based mocking for frontend teams, so they can develop against a live mock API generated by your design flow.

---

## üõ†Ô∏è Overview

- The **FastAPI chat microservice** generates `openapi.yaml`, `rules.md`, and `schema.json`.
- These are stored per `session_id` and exposed via REST endpoints:

  - `/api/files/{session_id}/openapi`
  - `/api/files/{session_id}/rules`
  - `/api/files/{session_id}/schema`

- The **VS Code Extension backend** (Node.js) does:

  1. Authenticates user/session.
  2. Fetches the `openapi.yaml` via REST.
  3. Saves it locally for Prism.
  4. Runs Prism as a mock server on the dev's machine.

---

## ‚öôÔ∏è Step-by-Step: Prism Integration

### 1. Fetch OpenAPI Spec From Microservice

Make a GET request from your Node.js extension backend:

```typescript
import fetch from "node-fetch";
import fs from "fs";
import path from "path";

const BASE_URL = "https://your-backend-service/api";

async function fetchOpenAPISpec(sessionId: string): Promise<string> {
  const res = await fetch(`${BASE_URL}/files/${sessionId}/openapi`);
  if (!res.ok) throw new Error(`Failed to fetch OpenAPI: ${res.statusText}`);
  const yaml = await res.text();

  // Save locally for Prism
  const filePath = path.join(__dirname, "openapi.yaml");
  fs.writeFileSync(filePath, yaml, "utf-8");
  return filePath;
}
```

---

### 2. Spawn Prism Locally

Start Prism using Node's `child_process.spawn`:

```typescript
import { spawn } from "child_process";

function startPrismMock(openapiPath: string, port: number = 4010) {
  const prism = spawn("npx", ["@stoplight/prism-cli", "mock", openapiPath, "-p", port.toString(), "-d"], {
    stdio: "inherit",
    shell: true,
  });

  prism.on("error", (err) => {
    console.error("Failed to start Prism:", err);
  });

  prism.on("close", (code) => {
    console.log(`Prism mock server exited with code ${code}`);
  });

  console.log(`‚úÖ Prism mock server running at http://localhost:${port}`);
}
```

- `-d` enables dynamic mock responses.
- `-p 4010` sets port (can be any free port).
- `npx` ensures no global install required.

---

### 3. Extension Command: Start Mock API

Register a VS Code command so users can start the mock server from the palette:

```typescript
import * as vscode from "vscode";

export async function activate(context: vscode.ExtensionContext) {
  const disposable = vscode.commands.registerCommand("mockApi.start", async () => {
    const sessionId = await vscode.window.showInputBox({ prompt: "Enter Session ID" });
    if (!sessionId) return;

    vscode.window.showInformationMessage("Fetching OpenAPI spec...");
    const filePath = await fetchOpenAPISpec(sessionId);

    vscode.window.showInformationMessage("Starting Prism mock server...");
    startPrismMock(filePath, 4010);
  });

  context.subscriptions.push(disposable);
}
```

- Enables:  
  - Open Command Palette  
  - Run ‚ÄúStart Mock API‚Äù  
  - Enter session_id  
  - Extension fetches spec and starts Prism server locally.

---

### 4. Prism Install: npx or Preinstall

- Uses `npx @stoplight/prism-cli mock openapi.yaml` for zero setup.
- If installed as devDependency:
  ```bash
  npm install @stoplight/prism-cli --save-dev
  ```
- Spawn changes to:
  ```typescript
  const prism = spawn("npx", ["prism", "mock", openapiPath, "-p", port.toString(), "-d"], {...});
  ```

---

### 5. Stopping Prism (Optional)

Track and kill the Prism process:

```typescript
let prismProcess: any;

function stopPrism() {
  if (prismProcess) {
    prismProcess.kill("SIGINT");
    console.log("üõë Prism mock server stopped.");
  }
}
```

---

## üö¶ Local Contract Validation

- **Mock Mode:**  
  - Use Prism to simulate API for frontend development.

- **Validate Mode:**  
  - Use [Pact](https://docs.pact.io/) or Stoplight contract testing to compare real backend responses to spec.

Future: Support both modes via VS Code commands for teams.

---

## ‚úÖ Backend Dev Implementation Summary

| Step         | Description                                  | Example Code                                  |
|--------------|----------------------------------------------|-----------------------------------------------|
| **1**        | Fetch `openapi.yaml` from FastAPI            | `fetchOpenAPISpec()`                          |
| **2**        | Write YAML file locally                      | `fs.writeFileSync()`                          |
| **3**        | Spawn Prism process with `npx`               | `spawn("npx", ["@stoplight/prism-cli", ...])` |
| **4**        | Show port/URL in VS Code                     | `http://localhost:4010`                       |
| **5**        | Auto-stop server if needed                   | `prismProcess.kill()`                         |

---

## üßë‚Äçüíª Developer Flow

1. **Chat** in Web UI to finalize API contract.
2. **Click "Generate"** ‚Üí microservice creates artifacts.
3. **Get `session_id`.**
4. **Run VS Code command:**  
    - Extension fetches spec from backend.
    - Starts Prism mock server at `http://localhost:4010`.
    - Frontend devs build against the live mock endpoints.

---

## üîó References

- [Stoplight Prism Docs](https://github.com/stoplightio/prism)
- [Prism CLI Usage](https://meta.stoplight.io/docs/prism/)
- [Node.js Child Process](https://nodejs.org/api/child_process.html)
